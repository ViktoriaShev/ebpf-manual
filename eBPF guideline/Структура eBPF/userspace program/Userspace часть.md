## Syscall
### Основные системные вызовы eBPF в userspace

Все eBPF-функции в userspace опираются на системный вызов `bpf()`:
```c
int bpf(enum bpf_cmd cmd, union bpf_attr *attr, unsigned int size);
```
Это универсальный системный вызов, через который реализуются все eBPF-операции. Различные **команды (`cmd`)** определяют поведение. 
## BPF Skeleton

Skeleton — это шаблон, используемый с bpftool (инструментом для взаимодействия с eBPF-подсистемой в Linux) для генерации заглушек и кода на C, облегчающего работу с eBPF-программами. Скелет создаётся на основе BPF-объектного файла (.o) с помощью bpftool gen skeleton.

Skeleton — это автоматически генерируемый заголовочный файл (.skel.h), который:

- Упрощает загрузку eBPF-программы в ядро.
- Предоставляет удобный API для взаимодействия с картами (maps) и программами.
- Избавляет от ручного парсинга ELF-файлов и работы с libbpf вручную.
  
Skeleton используется в userspace, вот некоторый список полезных команд:

Каждый раз, когда вызывается better_filter_bpf\_\_open(), создается новый объект с новыми картами (maps), и каждый раз, когда программа выполняет какие-либо действия, старые карты не удаляются или не очищаются. Это приводит к тому, что создаются новые экземпляры карт, а старые не удаляются, если не выполнить должные действия.

### Методы Skeleton'а и их разбор

#### 1. `better_filter_bpf__open()`

```c
skel = better_filter_bpf__open();
```
- **Что делает:** Открывает и инициализирует skeleton, но **не загружает** программу в ядро.
    
- **Когда используется:** Когда нужно только доступ к BPF картам или к структуре программы без загрузки в ядро (например, чтобы удалить фильтры, показать статистику и т.п.).

---

#### 2. `better_filter_bpf__load()`
```c
`better_filter_bpf__load(skel);`
```
- **Что делает:** Загружает eBPF-программу и карты в ядро. После этого можно прикреплять eBPF-программу к интерфейсам.
- **Когда используется:** Когда нужно использовать eBPF-программу (например, при добавлении/удалении фильтров, работе с картами и т.д.).
- **Важно:** Нужно вызывать после `__open()`.

---

#### 3. `better_filter_bpf__open_and_load()`

```c
skel = better_filter_bpf__open_and_load();
```
- **Что делает:** Комбинирует вызовы `__open()` и `__load()`.
- **Когда используется:** Когда сразу нужно открыть и загрузить eBPF-программу, например, перед прикреплением её к интерфейсу (`load` команда).

---

#### 4. `better_filter_bpf__destroy(skel)`
```c
better_filter_bpf__destroy(skel);
```
- **Что делает:** Освобождает ресурсы, связанные со skeleton'ом (в том числе память, файловые дескрипторы и пр.).
- **Когда используется:** В самом конце работы с skeleton'ом, при завершении программы или после выгрузки.

---
#### 5. `better_filter_bpf__detach(skel)`

```c
better_filter_bpf__detach(skel);
```
- **Что делает:** Отсоединяет eBPF-программу от интерфейса. Фактически вызывает `bpf_xdp_detach()`.
- **Когда используется:** В команде `unload` — чтобы снять программу с интерфейса перед удалением.

---
###  Доступ к картам и программам через Skeleton

Skeleton содержит две основные подструктуры:
#### `skel->maps`

Доступ к eBPF-картам (maps), определенным в `.bpf.c`:
```c
skel->maps.filter_map skel->maps.stats_map
```
Можно использовать с функциями `bpf_map__pin()`, `bpf_map__update_elem()` и т.п.
#### `skel->progs`

Доступ к eBPF-программам, таким как:
```c
skel->progs.xdp_filter
```
Программа `xdp_filter` — это сама XDP-программа, загружаемая и прикрепляемая к интерфейсу.

---