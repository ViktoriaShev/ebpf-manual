## –í–æ–ø—Ä–æ—Å—ã –Ω–∞ –±—É–¥—É—â–µ–µ:

  –£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –ø—Ä–æ —Ä–µ–≥–∏—Å—Ç—Ä—ã r0, r1- –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ r10

–†–µ–≥–∏—Å—Ç—Ä r0 —Ç–∞–∫–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã, –∞ –≤ —Ä–µ–≥–∏—Å—Ç—Ä–µ r1 –ø—Ä–æ–≥—Ä–∞–º–º–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç ‚Äî –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å, –Ω–∞–ø—Ä–∏–º–µ—Ä, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ struct xdp_md (–¥–ª—è XDP) –∏–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ struct \_\_sk_buff (–¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–µ—Ç–µ–≤—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º) –∏–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ struct pt_regs (–¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ tracing –ø—Ä–æ–≥—Ä–∞–º–º) –∏ —Ç.–ø.

https://habr.com/ru/articles/514736/

–í –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ–≥—Ä–∞–º–º–æ–π –ø–æ—è–≤–ª—è–ª–∏—Å—å –≤–æ–ø—Ä–æ—Å—ã:

—Å–∫–æ–ª—å–∫–æ –∂–∏–≤–µ—Ç ebpf –ø—Ä–æ–≥—Ä–∞–º–º–∞ –≤ —è–¥—Ä–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º ip link

XDP –ø—Ä–æ–≥—Ä–∞–º–º–∞ –±—É–¥–µ—Ç –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –≤ —è–¥—Ä–µ –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ –Ω–µ –±—É–¥–µ—Ç –≤—ã–≥—Ä—É–∂–µ–Ω–∞ –≤—Ä—É—á–Ω—É—é –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–æ–π. –û–Ω–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ä–∞–º–∫–∞—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç pinned –∫–∞—Ä—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –∏ –º–æ–≥—É—Ç –±—ã—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º.

–°–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –≤ —è–¥—Ä–µ –±–µ–∑ pinned –∫–∞—Ä—Ç?

–ë–µ–∑ pinned –∫–∞—Ä—Ç: –ï—Å–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã XDP –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ —Ñ–∞–π–ª–∞–º –≤ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ (–Ω–µ "pinned"), —Ç–æ –æ–Ω–∏ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ–∫–∞ –Ω–µ –ø—Ä–æ–∏–∑–æ–π–¥—É—Ç —Å–ª–µ–¥—É—é—â–∏–µ —Å–æ–±—ã—Ç–∏—è:


–í—ã–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É sudo ip link set dev <interface> xdp off.
–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —Å –∫–æ–º–∞–Ω–¥–æ–π xdp off –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã.
–£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã —Å –ø–æ–º–æ—â—å—é rm –∏–ª–∏ –¥—Ä—É–≥–æ–π –∫–æ–º–∞–Ω–¥—ã, –∫–æ—Ç–æ—Ä–∞—è –æ—á–∏—â–∞–µ—Ç pinned –∫–∞—Ä—Ç—ã.

–° pinned –∫–∞—Ä—Ç–∞–º–∏: –ï—Å–ª–∏ XDP –ø—Ä–æ–≥—Ä–∞–º–º–∞ –∏ –∫–∞—Ä—Ç—ã –±—ã–ª–∏ "pinned" –≤ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ (/sys/fs/bpf/), —Ç–æ –¥–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –∏–ª–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –±—É–¥—É—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω—ã, –ø—Ä–æ–≥—Ä–∞–º–º–∞ –∏ –∫–∞—Ä—Ç—ã –º–æ–≥—É—Ç –±—ã—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ —Ñ–∞–π–ª–æ–≤, –≤ –∫–æ—Ç–æ—Ä—ã–µ –æ–Ω–∏ –±—ã–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∞—Ä—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É) –∏ –∏—Ö –ø—Ä–∏–≤—è–∑–∞—Ç—å –∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É —Å–Ω–æ–≤–∞.

—Å–∫–æ–ª—å–∫–æ –∂–∏–≤–µ—Ç —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º skeleton

–ü—Ä–æ–≥—Ä–∞–º–º–∞, –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–∞—è –≤ —è–¥—Ä–æ —Å –ø–æ–º–æ—â—å—é BPF skeleton, –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ –Ω–µ –±—É–¥—É—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:

  
–í—ã–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã —Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —Å –ø–æ–º–æ—â—å—é xdp off.
–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∏–ª–∏ —Å–∏—Å—Ç–µ–º—ã.
–£–¥–∞–ª–µ–Ω–∏–µ pinned –∫–∞—Ä—Ç (–µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã).
–Ø–≤–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∏–ª–∏ –≤—ã–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã –≤—Ä—É—á–Ω—É—é.

---

## üíæ **–ö–æ–≥–¥–∞ —Ç—ã –º–æ–Ω—Ç–∏—Ä—É–µ—à—å `bpffs` (eBPF —Ñ–∞–π–ª–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É), –∫—É–¥–∞ –≤—Å—ë –ø–æ–ø–∞–¥–∞–µ—Ç?**

bash

–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å

`mount -t bpf none /sys/fs/bpf/`

- –≠—Ç–æ **–≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è —Ñ–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞**, –∫–∞–∫ –∏ `/proc`, `/sys`, `/dev`.
    
- –û–Ω–∞ **–Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–∞ –¥–∏—Å–∫–µ** (–Ω–µ –Ω–∞ SSD, –Ω–µ –Ω–∞ HDD).
    
- –§–∞–π–ª—ã –∏ –∫–∞—Ç–∞–ª–æ–≥–∏ –≤ –Ω–µ–π ‚Äî —ç—Ç–æ **–æ–±—ë—Ä—Ç–∫–∏ –Ω–∞–¥ –æ–±—ä–µ–∫—Ç–∞–º–∏ —è–¥—Ä–∞** (–≤ —á–∞—Å—Ç–Ω–æ—Å—Ç–∏, eBPF-–∫–∞—Ä—Ç–∞–º–∏ –∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞–º–∏).
    

> –¢–∞–∫ —á—Ç–æ –µ—Å–ª–∏ —Ç—ã –¥–µ–ª–∞–µ—à—å `bpf_map__pin()` –∏ –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Ñ–∞–π–ª –≤ `/sys/fs/bpf/filter_map`, —ç—Ç–æ **–Ω–µ —Ñ–∞–π–ª –Ω–∞ –¥–∏—Å–∫–µ**, –∞ "–¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä", —É–∫–∞–∑—ã–≤–∞—é—â–∏–π –Ω–∞ –æ–±—ä–µ–∫—Ç **–≤ –ø–∞–º—è—Ç–∏ —è–¥—Ä–∞**.

---

## üß† –ì–¥–µ —Ñ–∏–∑–∏—á–µ—Å–∫–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è eBPF –∫–∞—Ä—Ç—ã –∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã?

### üìç –û–Ω–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è **–≤ –æ—Å–Ω–æ–≤–Ω–æ–π –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ (RAM)**, –Ω–æ:

- **–≤ –∞–¥—Ä–µ—Å–Ω–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ —è–¥—Ä–∞**, –Ω–µ user space.
    
- –≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –ø–æ–¥—Å–∏—Å—Ç–µ–º–æ–π eBPF, —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞—Ö —è–¥—Ä–∞.
    

> –¢–æ –µ—Å—Ç—å: `filter_map` –∂–∏–≤—ë—Ç –≤ **kernel memory**, –∫–∞–∫ –∏ –ª—é–±–∞—è –¥—Ä—É–≥–∞—è BPF map.

---

## üßµ –ß—Ç–æ –∑–Ω–∞—á–∏—Ç "–≤ —è–¥—Ä–µ"?

–ö–æ–≥–¥–∞ –º—ã –≥–æ–≤–æ—Ä–∏–º, —á—Ç–æ **BPF map –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —è–¥—Ä–µ**, —ç—Ç–æ –∑–Ω–∞—á–∏—Ç:

- –û–Ω–∞ —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è **—è–¥—Ä–æ–º Linux**.
    
- –•—Ä–∞–Ω–∏—Ç—Å—è –≤ –µ–≥–æ **–∞–¥—Ä–µ—Å–Ω–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ**.
    
- –ù–µ –¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞–ø—Ä—è–º—É—é –∏–∑ userspace ‚Äî —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ syscalls (`bpf()`) –∏ —Ç–∞–∫–∏–µ –æ–±—ë—Ä—Ç–∫–∏ –∫–∞–∫ `libbpf`.
    

–≠—Ç–æ **—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö**, –∫–æ—Ç–æ—Ä–∞—è –∂–∏–≤—ë—Ç –≤ –ø–∞–º—è—Ç–∏ –∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ, –¥–æ—Å—Ç—É–ø–Ω–æ–º eBPF –∏ —è–¥—Ä—É.

---

## üóÇÔ∏è –ê —á—Ç–æ —Ç–æ–≥–¥–∞ –¥–µ–ª–∞–µ—Ç `pinning`?

–ö–æ–≥–¥–∞ —Ç—ã "–ø—Ä–∏—à–ø–∏–ª–∏–≤–∞–µ—à—å" –∫–∞—Ä—Ç—É –≤ `bpffs`, –Ω–∞–ø—Ä–∏–º–µ—Ä:

c

–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å

`bpf_map__pin(map, "/sys/fs/bpf/filter_map");`

–¢—ã –ø—Ä–æ—Å—Ç–æ:

- –°–æ–∑–¥–∞—ë—à—å **–ø—É—Ç—å –≤ `bpffs`**, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º **–æ–±—Ä–∞—Ç–∏—Ç—å—Å—è** –∫ –æ–±—ä–µ–∫—Ç—É –ø–æ –∏–º–µ–Ω–∏.
    
- –≠—Ç–æ –∫–∞–∫ —Å–∏–º–ª–∏–Ω–∫ –∏–ª–∏ —Ö–µ–Ω–¥–ª: —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ map, **–∫–æ—Ç–æ—Ä–∞—è —É–∂–µ –µ—Å—Ç—å –≤ –ø–∞–º—è—Ç–∏**.
    

–ï—Å–ª–∏ —Ç—ã –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—à—å —Å–≤–æ—ë –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Äî —Ç—ã –º–æ–∂–µ—à—å –æ—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É —Å —Ç–µ–º –∂–µ –ø—É—Ç—ë–º:

c

–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å

`int fd = bpf_obj_get("/sys/fs/bpf/filter_map");`

---

## üß†üìå –ò—Ç–æ–≥–æ:

|–û–±—ä–µ–∫—Ç|–ì–¥–µ —Ñ–∏–∑–∏—á–µ—Å–∫–∏?|–ß—Ç–æ –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å|
|---|---|---|
|eBPF –∫–∞—Ä—Ç–∞|–í –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ (RAM), –∞–¥—Ä–µ—Å–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ —è–¥—Ä–∞|–§–∞–π–ª –≤ `/sys/fs/bpf/` –ø–æ—Å–ª–µ `pin`|
|eBPF –ø—Ä–æ–≥—Ä–∞–º–º–∞|–í –ø–∞–º—è—Ç–∏ —è–¥—Ä–∞|–ß–µ—Ä–µ–∑ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä –ø—Ä–æ–≥—Ä–∞–º–º—ã (`bpf_program__fd`)|
|–§–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞|–í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è (`bpffs`)|–ü—É—Ç—å –∫ –æ–±—ä–µ–∫—Ç–∞–º eBPF —á–µ—Ä–µ–∑ `/sys/fs/bpf/`|

---

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –º–æ–≥—É –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å –Ω–∞–≥–ª—è–¥–Ω—É—é —Å—Ö–µ–º—É —Å —É—Ä–æ–≤–Ω—è–º–∏: Userspace ‚Üî Kernel ‚Üî RAM, –∏ –ø–æ–∫–∞–∑–∞—Ç—å, –≥–¥–µ —á—Ç–æ "–∂–∏–≤–µ—Ç".