# –ê–Ω–∞–ª–∏–∑ userspace –∫–æ–¥–∞ –¥–ª—è XDP-—Ñ–∏–ª—å—Ç—Ä–∞

–≠—Ç–æ—Ç –∫–æ–¥ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —É–ø—Ä–∞–≤–ª—è—é—â—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É –¥–ª—è XDP (eXpress Data Path) —Ñ–∏–ª—å—Ç—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ —è–¥—Ä–∞ Linux –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å–µ—Ç–µ–≤—ã—Ö –ø–∞–∫–µ—Ç–æ–≤. –†–∞–∑–±–µ—Ä–µ–º –µ–≥–æ –ø–æ–¥—Ä–æ–±–Ω–æ.
## –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **–ó–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã–µ —Ñ–∞–π–ª—ã**: 
   - –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ C-–±–∏–±–ª–∏–æ—Ç–µ–∫–∏ (`stdio.h`, `stdlib.h`, `string.h`, `unistd.h`)
   - –°–µ—Ç–µ–≤—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ (`net/if.h`, `arpa/inet.h`)
   - –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è Linux –∏ BPF –∑–∞–≥–æ–ª–æ–≤–∫–∏ (`linux/if_link.h`, `bpf/libbpf.h`, `bpf/bpf.h`)
   - –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–∫–µ–ª–µ—Ç–æ–Ω–∞ BPF –ø—Ä–æ–≥—Ä–∞–º–º—ã (`better_filter.skel.h`)

2. **–°—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö**:
   - `struct filter` - –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–ª—é—á –¥–ª—è –∫–∞—Ä—Ç—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (IP-–∞–¥—Ä–µ—Å –∏ –ø–æ—Ä—Ç)

3. **–ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã**:
   - –ü—É—Ç–∏ –∫ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–º (pinned) BPF-–∫–∞—Ä—Ç–∞–º –≤ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ (`BPF_MAP_PATH_FILTER`, `BPF_MAP_PATH_STATS`)

## –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

–ü—Ä–æ–≥—Ä–∞–º–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–º–∞–Ω–¥:

### 1. –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –≤—ã–≥—Ä—É–∑–∫–∞ XDP-–ø—Ä–æ–≥—Ä–∞–º–º—ã

- **`load`**: –û—Ç–∫—Ä—ã–≤–∞–µ—Ç, –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏ –ø—Ä–∏–∫—Ä–µ–ø–ª—è–µ—Ç XDP-–ø—Ä–æ–≥—Ä–∞–º–º—É –∫ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É —Å–µ—Ç–µ–≤–æ–º—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
- **`unload`**: –û—Ç—Å–æ–µ–¥–∏–Ω—è–µ—Ç XDP-–ø—Ä–æ–≥—Ä–∞–º–º—É –∏ —É–¥–∞–ª—è–µ—Ç –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã

### 2. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

- **`add`**: –î–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–∞–≤–∏–ª–æ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (IP + –ø–æ—Ä—Ç)
- **`del`**: –£–¥–∞–ª—è–µ—Ç –ø—Ä–∞–≤–∏–ª–æ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
- **`list`**: –í—ã–≤–æ–¥–∏—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

- **`stats`**: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º –ø–∞–∫–µ—Ç–∞–º (—Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ/–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)

## –î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä —Ñ—É–Ω–∫—Ü–∏–π

### 1. –ö–∞–∫ skeleton –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ

---

#### üì¶  `better_filter_bpf *skel`

`skeleton` (`skel`) ‚Äî —ç—Ç–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è `bpftool gen skeleton` –∏–ª–∏ `libbpf` –ø—Ä–∏ –ø–æ–º–æ—â–∏ `clang + BTF`.  
–û–Ω–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —É–¥–æ–±–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫:

- eBPF-–ø—Ä–æ–≥—Ä–∞–º–º–∞–º,
    
- eBPF-–∫–∞—Ä—Ç–∞–º,
    
- —Å–∏—Å—Ç–µ–º–Ω—ã–º –æ–±—ë—Ä—Ç–∫–∞–º –∑–∞–≥—Ä—É–∑–∫–∏/–æ—Ç–∫—Ä—ã—Ç–∏—è/—É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ `better_filter_bpf` —Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ `.bpf.c`-—Ñ–∞–π–ª—É.

---

####–ì–¥–µ –∏ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `skel`

##### 1. **`better_filter_bpf__open_and_load()`**

```c
skel = better_filter_bpf__open_and_load();
```

- –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –¥–µ–ª–∞–µ—Ç:
    
    - `better_filter_bpf__open()` ‚Äî –æ—Ç–∫—Ä—ã—Ç—å BPF-–æ–±—ä–µ–∫—Ç (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—ã, –∫–∞—Ä—Ç—ã –∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã).
        
    - `better_filter_bpf__load()` ‚Äî –∑–∞–≥—Ä—É–∑–∏—Ç—å –µ–≥–æ –≤ —è–¥—Ä–æ (—á–µ—Ä–µ–∑ `bpf()` syscall).
        

üîß –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ `load`.

---

##### 2. **`better_filter_bpf__open()`**

```c
skel = better_filter_bpf__open();
```

- –¢–æ–ª—å–∫–æ **–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç BPF skeleton** ‚Äî –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤ —è–¥—Ä–æ!
    
- –î–∞—ë—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–∞—Ä—Ç–∞–º, –ø—Ä–æ–≥—Ä–∞–º–º–∞–º –∏ –∏—Ö –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–∞–º.
    

üìå –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏:

- `unload` ‚Äî —á—Ç–æ–±—ã –≤—ã–∑–≤–∞—Ç—å `__detach()`
    
- `add`, `del`, `list`, `stats` ‚Äî —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞—Ç—å —Å –∫–∞—Ä—Ç–∞–º–∏
    

---

##### 3. **`better_filter_bpf__load()`**

```c
err = better_filter_bpf__load(skel);
```

- –ó–∞–≥—Ä—É–∂–∞–µ—Ç eBPF-–ø—Ä–æ–≥—Ä–∞–º–º—É –∏ –∫–∞—Ä—Ç—ã –≤ —è–¥—Ä–æ.
    
- –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã (`fd`) –ø—Ä–æ–≥—Ä–∞–º–º–∞–º –∏ –∫–∞—Ä—Ç–∞–º.
    

üìå –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ `add`, `del`, `list`, `stats`, –ø–æ—Ç–æ–º—É —á—Ç–æ –ø–æ—Å–ª–µ `__open()` –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å `__load()`.

---

##### 4. **`better_filter_bpf__destroy()`**

```c
better_filter_bpf__destroy(skel);
```

- **–û—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç —Ä–µ—Å—É—Ä—Å—ã**, –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã.
    
- –ë–µ–∑ —ç—Ç–æ–≥–æ –±—É–¥–µ—Ç —É—Ç–µ—á–∫–∞ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤ –∏ –ø–∞–º—è—Ç–∏ –≤ userspace.
    

üìå –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ `cleanup:` –≤ –∫–æ–Ω—Ü–µ `main()`.

---

##### 5. **`better_filter_bpf__detach()`**

```c
better_filter_bpf__detach(skel);
```

- –û—Ç—Å–æ–µ–¥–∏–Ω—è–µ—Ç eBPF-–ø—Ä–æ–≥—Ä–∞–º–º—É –æ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞, –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∞ —á–µ—Ä–µ–∑ skeleton.
    
- –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç—ã –ø—Ä–∏–∫—Ä–µ–ø–ª—è–ª –ø—Ä–æ–≥—Ä–∞–º–º—ã —á–µ—Ä–µ–∑ `bpf_program__attach()` –∏–ª–∏ –ø–æ–¥–æ–±–Ω—ã–µ API.
    

‚ùó –í –∫–æ–¥–µ `attach` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä—É—á–Ω–æ–µ `bpf_xdp_attach()`, –ø–æ—ç—Ç–æ–º—É `__detach()` –º–æ–∂–µ—Ç –Ω–∏—á–µ–≥–æ –Ω–µ —Å–¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ attach –±—ã–ª –Ω–µ —á–µ—Ä–µ–∑ skeleton.

---

### 2. –†–∞–±–æ—Ç–∞ —Å –∫–∞—Ä—Ç–∞–º–∏ 
#####  –¢–∏–ø—ã BPF-–∫–∞—Ä—Ç

1. **`filter_map`** ‚Äî –∫–∞—Ä—Ç–∞, —Å–æ–¥–µ—Ä–∂–∞—â–∞—è –ø—Ä–∞–≤–∏–ª–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–∞–∫–µ—Ç–æ–≤ –ø–æ IP –∏ –ø–æ—Ä—Ç—É.
    
    - –¢–∏–ø: —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ `BPF_MAP_TYPE_HASH` (–ø–æ –∫–ª—é—á—É `struct filter`)
        
    - –ö–ª—é—á: `struct filter` —Å IP –∏ –ø–æ—Ä—Ç–æ–º
        
    - –ó–Ω–∞—á–µ–Ω–∏–µ: `int` (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1 ‚Äî –∞–∫—Ç–∏–≤–µ–Ω)
        
2. **`stats_map`** ‚Äî –∫–∞—Ä—Ç–∞ –¥–ª—è —Å–±–æ—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (—Ä–∞–∑—Ä–µ—à–µ–Ω–æ/–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ).
    
    - –¢–∏–ø: `BPF_MAP_TYPE_ARRAY`
        
    - –ö–ª—é—á: `int` (0 –∏–ª–∏ 1)
        
    - –ó–Ω–∞—á–µ–Ω–∏–µ: `unsigned long long` (—Å—á–µ—Ç—á–∏–∫–∏)
	
##### –î–æ—Å—Ç—É–ø –∫ –∫–∞—Ä—Ç–∞–º –∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞–º 

```c
skel->maps.filter_map
skel->maps.stats_map
skel->progs.xdp_filter
```

–≠—Ç–∏ –ø–æ–ª—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ eBPF-–ø—Ä–æ–≥—Ä–∞–º–º—ã:

- `maps` ‚Äî –¥–æ—Å—Ç—É–ø –∫ eBPF map'–∞–º –ø–æ –∏—Ö –Ω–∞–∑–≤–∞–Ω–∏—é.
    
- `progs` ‚Äî –¥–æ—Å—Ç—É–ø –∫ eBPF-–ø—Ä–æ–≥—Ä–∞–º–º–∞–º –ø–æ –∏–º–µ–Ω–∏ —Ñ—É–Ω–∫—Ü–∏–∏.
    

‚ùó –ù–∞–∑–≤–∞–Ω–∏—è –±–µ—Ä—É—Ç—Å—è –∏–∑ `.bpf.c` —Ñ–∞–π–ª–∞:

```c
struct {
    __uint(type, BPF_MAP_TYPE_HASH);
    ...
} filter_map SEC(".maps");

SEC("xdp")
int xdp_filter(...) { ... }
```

---

##### –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ –≤ bpffs

–ö–∞—Ä—Ç—ã –∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —è–¥—Ä–µ –¥–∞–∂–µ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ:

- –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã 

```c
bpf_map__pin(skel->maps.filter_map, BPF_MAP_PATH_FILTER);
bpf_map__pin(skel->maps.stats_map, BPF_MAP_PATH_STATS);
```

`bpf_map__pin()` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–∞—Ä—Ç—É –≤ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ (`/sys/fs/bpf/...`). –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥—Ä—É–≥–∏–º –ø—Ä–æ–≥—Ä–∞–º–º–∞–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ—ë –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ —Ç–µ–∫—É—â–µ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã. –ü–æ–ª–µ–∑–Ω–æ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–∑ userspace.

- **–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã** 
¬†
```c
¬† bpf_program\_\_pin(skel->progs.my_prog, "/sys/fs/bpf/xdp_prog");
¬† ````

–ü–æ—Å–ª–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ bpffs –∏ –æ—Å—Ç–∞—é—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –¥–∞–∂–µ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º.


---

##### 3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞**

```c
bpf_map__update_elem(map, &key, sizeof(key), &value, sizeof(value), BPF_ANY);
```

üîÅ `bpf_map__update_elem()` –¥–æ–±–∞–≤–ª—è–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —ç–ª–µ–º–µ–Ω—Ç –≤ –∫–∞—Ä—Ç–µ:

- `map`: —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –∫–∞—Ä—Ç—É
    
- `key`, `value`: –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    
- `BPF_ANY`: –µ—Å–ª–∏ –∫–ª—é—á –µ—Å—Ç—å ‚Äî –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å, –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –¥–æ–±–∞–≤–∏—Ç—å
    

–ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –≤:

```c
add_filter(...) // –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –≤ filter_map
```

---

##### 4. **–£–¥–∞–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞**

```c
bpf_map__delete_elem(map, &key, sizeof(key), 0);
```

‚ùå –£–¥–∞–ª—è–µ—Ç —ç–ª–µ–º–µ–Ω—Ç –∏–∑ –∫–∞—Ä—Ç—ã –ø–æ –∫–ª—é—á—É.

- –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –≤ `delete_filter(...)`
    

---

##### 5. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∫–ª—é—á–∞ (–∏—Ç–µ—Ä–∞—Ü–∏—è)**

```c
bpf_map__get_next_key(map, &key, &next_key, sizeof(key))
```

üîÑ –ü–æ–∑–≤–æ–ª—è–µ—Ç –∏—Ç–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ —ç–ª–µ–º–µ–Ω—Ç–∞–º –∫–∞—Ä—Ç—ã. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π –∫–ª—é—á –ø–æ—Å–ª–µ `key`.

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤:

```c
list_filters(...) // –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Å–µ—Ö –ø—Ä–∞–≤–∏–ª
```

–í–∞–∂–Ω–æ:

- –î–ª—è –Ω–∞—á–∞–ª–∞ –∏—Ç–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `0` (–Ω—É–ª–µ–≤–æ–π `struct filter`)
    
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `-ENOENT`, –∫–æ–≥–¥–∞ —ç–ª–µ–º–µ–Ω—Ç—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å
    

---

##### 6. **–ß—Ç–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ –∫–ª—é—á—É**

```c
bpf_map__lookup_elem(map, &key, sizeof(key), &value, sizeof(value), 0)
```

üîç –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ –∫–ª—é—á—É.

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö:

- –í `list_filters(...)` ‚Äî —á–∏—Ç–∞–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ —É –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞
    
- –í `show_stats(...)` ‚Äî —á–∏—Ç–∞—é—Ç—Å—è —Å—á–µ—Ç—á–∏–∫–∏ —Å –∫–ª—é—á–∞–º–∏ 0 (—Ä–∞–∑—Ä–µ—à–µ–Ω–æ) –∏ 1 (–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ)
    

---

##### üìå –†–µ–∑—é–º–µ ‚Äî –ú–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç—ã —Å –∫–∞—Ä—Ç–∞–º–∏:

|–ú–µ—Ç–æ–¥|–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ|
|---|---|
|`bpf_map__pin`|–ü—É–±–ª–∏–∫–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –≤ bpffs|
|`bpf_map__update_elem`|–î–æ–±–∞–≤–ª–µ–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –∫–∞—Ä—Ç–µ|
|`bpf_map__delete_elem`|–£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∏–∑ –∫–∞—Ä—Ç—ã|
|`bpf_map__get_next_key`|–ò—Ç–µ—Ä–∞—Ü–∏—è –ø–æ –∫–ª—é—á–∞–º –∫–∞—Ä—Ç—ã|
|`bpf_map__lookup_elem`|–ü–æ–ª—É—á–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ –∫–ª—é—á—É|

---

### 3. **–†–∞–±–æ—Ç–∞ —Å bpf_map__ API –≤–º–µ—Å—Ç–æ —Å—ã—Ä–æ–≥–æ `bpf()`**

`bpf_map__*` ‚Äî —ç—Ç–æ **–æ–±–µ—Ä—Ç–∫–∏ –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ `libbpf`**, –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –¥–ª—è —É–¥–æ–±–Ω–æ–π, –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∏ —á–∏—Ç–∞–µ–º–æ–π —Ä–∞–±–æ—Ç—ã —Å BPF-–∫–∞—Ä—Ç–∞–º–∏.

–û–Ω–∏ –∏–∑–±–∞–≤–ª—è—é—Ç –æ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é —É–ø—Ä–∞–≤–ª—è—Ç—å —Ñ–∞–π–ª–æ–≤—ã–º–∏ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–∞–º–∏ –∫–∞—Ä—Ç, –∫–ª—é—á–∞–º–∏/–∑–Ω–∞—á–µ–Ω–∏—è–º–∏, –±–∞–π—Ç–∞–º–∏, –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ–º –∏ —Å–∏—Å—Ç–µ–º–Ω—ã–º–∏ –≤—ã–∑–æ–≤–∞–º–∏ `bpf(BPF_MAP_*, ...)`.


```c
bpf_map__update_elem(...)
bpf_map__delete_elem(...)
bpf_map__lookup_elem(...)
bpf_map__get_next_key(...)
```

- –í —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è `bpf()` –Ω–∞–ø—Ä—è–º—É—é (`BPF_MAP_LOOKUP_ELEM` –∏ —Ç.–¥.).

–†–∞–±–æ—Ç–∞—è —Å `bpf()` –Ω–∞–ø—Ä—è–º—É—é, —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è:

- –ü–æ–ª—É—á–∞—Ç—å FD –∫–∞—Ä—Ç—ã –≤—Ä—É—á–Ω—É—é
- –£–ø–∞–∫–æ–≤—ã–≤–∞—Ç—å –∫–ª—é—á –∏ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ `union bpf_attr`
- –°–ª–µ–¥–∏—Ç—å –∑–∞ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ–º –∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏
- –ü–∏—Å–∞—Ç—å –º–Ω–æ–≥–æ –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤–æ–≥–æ –∫–æ–¥–∞

–° API `bpf_map__*` –≤—Å—ë –ø—Ä–æ—â–µ –∏ —á–∏—â–µ ‚Äî –±–ª–∞–≥–æ–¥–∞—Ä—è –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ —á–µ—Ä–µ–∑ `struct bpf_map *`.
**–ü–ª—é—Å:**

> –ë–µ–∑–æ–ø–∞—Å–Ω–µ–µ, –ø—Ä–æ—â–µ, –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤, –º–µ–Ω—å—à–µ boilerplate.


---

### 4.  **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (`stats_map`) –∏ –ª–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è**

–§—É–Ω–∫—Ü–∏—è `show_stats(struct better_filter_bpf *skel)` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—É—Å–∫–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É:

```bash
./your_program eth0 stats
```

–¢–æ –µ—Å—Ç—å, –æ–Ω–∞ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è **–ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–∞–∫–µ—Ç–æ–≤ XDP-–ø—Ä–æ–≥—Ä–∞–º–º–æ–π**.

---
#### –ß—Ç–æ —Ç–∞–∫–æ–µ `stats_map`

–≠—Ç–æ **BPF-–∫–∞—Ä—Ç–∞**, —Å–æ–¥–µ—Ä–∂–∞—â–∞—è **—Å—á–µ—Ç—á–∏–∫–∏ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤**.

–°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –æ–Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤ BPF-–ø—Ä–æ–≥—Ä–∞–º–º–µ –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫:

```c
struct {
    __uint(type, BPF_MAP_TYPE_ARRAY);
    __uint(max_entries, 2);
    __type(key, __u32);
    __type(value, __u64);
} stats_map SEC(".maps");
```

- `key == 0` ‚Üí –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ **—Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö** (allowed) –ø–∞–∫–µ—Ç–æ–≤
    
- `key == 1` ‚Üí –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ **–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö** (blocked) –ø–∞–∫–µ—Ç–æ–≤
    
–≠—Ç–∏ —Å—á–µ—Ç—á–∏–∫–∏ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É—é—Ç—Å—è –≤ —Å–∞–º–æ–π BPF-–ø—Ä–æ–≥—Ä–∞–º–º–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, –±—ã–ª –ª–∏ –ø–∞–∫–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω –∏–ª–∏ –æ—Ç–±—Ä–æ—à–µ–Ω.

---

####  –†–∞–∑–±–æ—Ä `show_stats()`

#####  –ü–æ—à–∞–≥–æ–≤–∞—è –ª–æ–≥–∏–∫–∞:

1. **–ü–æ–ª—É—á–∞–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –∫–∞—Ä—Ç—É:**
    
    ```c
    struct bpf_map *stats_map = skel->maps.stats_map;
    ```
    
    –ï—Å–ª–∏ –∫–∞—Ä—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ ‚Äî –æ—à–∏–±–∫–∞.
    
2. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–ª—é—á 0 –∏ —á–∏—Ç–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ:**
    
    ```c
    int zero = 0;
    bpf_map__lookup_elem(stats_map, &zero, ..., &allowed, ...)
    ```
    
    –≠—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ **—Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö** –ø–∞–∫–µ—Ç–æ–≤.
    
3. **–ó–∞—Ç–µ–º –∫–ª—é—á 1 ‚Üí –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã:**
    
    ```c
    zero = 1;
    bpf_map__lookup_elem(stats_map, &zero, ..., &blocked, ...)
    ```
    
4. **–í—ã–≤–æ–¥–∏–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ –∫–æ–Ω—Å–æ–ª—å:**
    
    ```c
    printf("Allowed packets: %llu\n", allowed);
    printf("Blocked packets: %llu\n", blocked);
    ```

---
#### –ì–¥–µ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è stats_map

–≠—Ç–∞ –ª–æ–≥–∏–∫–∞ –æ–±—ã—á–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ eBPF-–ø—Ä–æ–≥—Ä–∞–º–º–µ (–≤ `xdp_filter()` –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏):

```c
static void update_stats(int key, unsigned long long increment)
{
¬† ¬† unsigned long long *count = bpf_map_lookup_elem(&stats_map, &key);
¬† ¬† if (count) {
¬† ¬† ¬† ¬† __sync_fetch_and_add(count, increment);
¬† ¬† } else {
¬† ¬† ¬† ¬† unsigned long long init = increment;
¬† ¬† ¬† ¬† bpf_map_update_elem(&stats_map, &key, &init, BPF_ANY);
¬† ¬† }
}
```

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –∫–∞–∂–¥—ã–π –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –ø–∞–∫–µ—Ç –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Å—á–µ—Ç—á–∏–∫.

---
#### –ó–∞—á–µ–º –Ω—É–∂–Ω–∞ `show_stats()`

- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, **–Ω–∞—Å–∫–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω–æ —Ñ–∏–ª—å—Ç—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç**: —Å–∫–æ–ª—å–∫–æ –ø–∞–∫–µ—Ç–æ–≤ –ø—Ä–æ—à–ª–æ, –∞ —Å–∫–æ–ª—å–∫–æ –±—ã–ª–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ.
- –£–¥–æ–±–Ω–æ –¥–ª—è **–æ—Ç–ª–∞–¥–∫–∏**, **–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞** –∏ **–¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Ñ–∏–ª—å—Ç—Ä–∞**.

---

##  –ß—Ç–æ –Ω–æ–≤–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è (–ø–æ –º–µ—Ç–æ–¥–∞–º/—Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º)

|–ù–æ–≤–æ–µ / —É–ª—É—á—à–µ–Ω–Ω–æ–µ|–ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è|–ß—Ç–æ —ç—Ç–æ –¥–∞—ë—Ç|
|---|---|---|
|eBPF Skeleton API (`.skel.h`)|`better_filter_bpf__open_and_load()`|–£–ø—Ä–æ—â—ë–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ eBPF|
|`bpf_map__*()` API|`lookup_elem`, `update_elem`, `delete_elem`|–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –∫–∞—Ä—Ç–∞–º–∏|
|Pinning –∫–∞—Ä—Ç –≤ BPF FS|`bpf_map__pin()`|–•—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –º–µ–∂–¥—É —Å–µ—Å—Å–∏—è–º–∏|
|–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π CLI|`add/del/list/stats`|–ì–∏–±–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ|
|–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç—Ä–∞—Ñ–∏–∫–∞|`stats_map`, `show_stats()`|–ù–∞–≥–ª—è–¥–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥|
|–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏|`strerror(-err)`|–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞|

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ libbpf**: –ö–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π API libbpf –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å BPF –ø—Ä–æ–≥—Ä–∞–º–º–∞–º–∏
2. **–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã**: BPF-–∫–∞—Ä—Ç—ã –∑–∞–∫—Ä–µ–ø–ª—è—é—Ç—Å—è –≤ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É –∑–∞–ø—É—Å–∫–∞–º–∏
3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: –ü—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –∫–æ–¥—ã –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
4. **–°–∫–µ–ª–µ—Ç–æ–Ω BPF**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–∫–µ–ª–µ—Ç–æ–Ω –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Ä–∞–±–æ—Ç—ã —Å BPF –ø—Ä–æ–≥—Ä–∞–º–º–æ–π


---
[–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è libbpf](https://libbpf.readthedocs.io/en/latest/api.html)




