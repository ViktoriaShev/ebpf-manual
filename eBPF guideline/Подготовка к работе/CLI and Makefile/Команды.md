Ниже представлены необходимые и дающие дополнительную информацию команды( команды используются для примера для программ простого xdp фильтра):
## 1. Компиляция и загрузка в ядро:

Эта команда компилирует исходный код eBPF (xdp_filter.bpf.c) в объектный файл (xdp_filter.o), который затем загружается в ядро Linux.

- O2 (Оптимизация уровня 2)

  Средний уровень оптимизации, который:
  Удаляет избыточный код.
  Улучшает использование регистров.
  Минимизирует ветвления.

- target bpf - указывает, что код должен быть скомпилирован не для x86/ARM, а для BPF-виртуальной машины.
  Генерирует байткод, который выполняется внутри ядра Linux.

- g (Отладочная информация) Включает отладочную информацию в формате DWARF.
- c (Только компиляция, без линковки)
  Преобразует xdp_filter.bpf.c в объектный файл xdp_filter.o без создания исполняемого файла.

  Линковка в eBPF не требуется, так как объектный файл загружается прямо в ядро.\

```

clang -O2 -target bpf -g -c xdp_filter.bpf.c -o xdp_filter.o

```

## 2. Загрузка eBPF в XDP (на нужный интерфейс, например, eth0):

Эта команда загружает eBPF-программу (из файла xdp_filter.o) в сетевой интерфейс (enp0s3) с использованием XDP (eXpress Data Path).

ip link -Утилита ip управляет сетевыми интерфейсами в Linux. Подкоманда link отвечает за изменение параметров интерфейсов.
set dev enp0s3 set dev — команда для изменения параметров указанного интерфейса.
enp0s3 — имя сетевого интерфейса (может быть eth0, wlp2s0 и т. д.).
xdp obj xdp_filter.o xdp — указывает, что загружается eBPF-программа для XDP.
sec xdp -sec (section) — указывает секцию в eBPF-программе, которую нужно загрузить.

  

Принцип работы:

- Открывает eBPF-объектный файл xdp_filter.o.
- Ищет секцию xdp в xdp_filter.o.
- Загружает eBPF-программу в XDP-систему ядра.
- Привязывает eBPF-фильтр к сетевому интерфейсу enp0s3.
- Начинает обработку входящих пакетов через XDP, работая на уровне драйвера сетевой карты.

```

ip link set dev enp0s3 xdp obj xdp_filter.o sec xdp

```

## 3.  Монтирование BPF-файловой системы (если еще не сделано):

```

mount -t bpf bpf /sys/fs/bpf

```

## 4. Закрепление eBPF-карты:

Закрепление(pin) в файловой системе означает, что есть дополнительная ссылка на карту (map), поэтому map остается загруженной после завершения команды.

```

bpftool map pin name filter_map /sys/fs/bpf/filter_map

```

## 5. Компиляция пользовательской программы, работающей с eBPF:

```

gcc -o program_user program_user.c -lbpf

```

## 6. Генерация заголовочного файла skel.h 

```
bpftool gen skeleton your_program.o > your_program.skel.h
```

## 6. (Отладка) Просмотр трассировки eBPF-программы:

```

sudo cat /sys/kernel/debug/tracing/trace_pipe

```

## 7. (Отладка) Просмотр сообщений ядра:

```

sudo dmesg -w

```

## 8. (Отключение) Если нужно отключить eBPF-программу:

Удаление программы XDP с помощью ip link можно выполнить следующим образом: 

```

sudo ip link set dev eth0 xdp off

```

## 9. (Диагностика) Проверка статистики XDP:

```

ethtool -S enp0s3 | grep xdp

```
--- 
## Другие полезные программы 
### tcpdump

```
sudo tcpdump -i enp0s3 tcp and port 80 -n -vvv 
```

- `tcpdump` — утилита для захвата и анализа сетевого трафика.
- `-i enp0s3` — захватывать пакеты на интерфейсе `enp0s3`.
- `tcp and port 80` — фильтр BPF: показать только TCP-пакеты, где источник или назначение — порт 80 (обычно HTTP).
- `-n` — не пытаться резолвить IP-адреса в доменные имена (ускоряет вывод).
- `-vvv` — максимальный уровень детализации: показывает как можно больше информации о каждом пакете.

Где работает `tcpdump`?

### Уровень сетевой модели:

`tcpdump` работает на **канальном уровне (Layer 2) и сетевом уровне (Layer 3)** модели OSI:

- Использует **libpcap** — библиотеку для захвата пакетов.
- Через **сырые сокеты** (`raw sockets`) или **AF_PACKET** интерфейс читает данные **напрямую с интерфейса**, до того как они попадут в стек TCP/IP ОС.
- Работает в **пассивном режиме** — он только слушает, не вмешивается в трафик.

1. **libpcap** открывает интерфейс и вешает BPF-фильтр (тот, что ты указал: `tcp and port 80`).
2. BPF-фильтр (Berkeley Packet Filter) на ядре отсеивает ненужные пакеты — только TCP-пакеты с/на порт 80 проходят дальше.
3. Все подходящие пакеты передаются в userspace, где `tcpdump` их парсит и красиво выводит.
4. `-vvv` заставляет `tcpdump` разбирать заголовки: Ethernet, IP, TCP, возможно даже HTTP.

### Правила firewall

Проверить: 

```bash
sudo iptables -L -v -n
sudo ip6tables -L -v -n
```

Если есть политики типа `DROP` — временно отключить:

```bash
sudo iptables -F
```
